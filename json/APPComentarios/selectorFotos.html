<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <link href="estilo.css" rel="stylesheet" />
    <script type="text/javascript" src="./funciones.js"></script>
</head>
<script>

    window.onload = obtenerImagenes;
    //http://10.1.2.10:8081/cfticionic/fotos

    const URI_SERVICE = "http://10.1.2.10:8081/cfticionic/fotos";
    const URI_SERVICE_INFO = "http://10.1.2.10:8081/cfticionic/foto"; //?key=CQOYQYTQ3CP3&idfoto=3";

    var uri;
    var xmlHttp;
    var login;
    var mensajeFotos; // almacena el usuario, token y la lista de fotos obtenida, con su info.
    var comentariosFoto;
    // token 1: MH3OOWHWKKO3
    // token 2: HMFFLHHWKKO3

    class Usuario {
        constructor(n, l, t) { this.nombre = n; this.pwd = l; this.tkn = t; }
        verUsuario() { console.log(this); console.log("usuario:" + this.numero + "-" + this.pwd + "-" + this.tkn); }
        toString() { return JSON.stringify(this); }
        toToken() { return this.nombre + this.tkn; }

        setToken(valor) { this.tkn = valor; }
    }
    class MensajeFotos {
        constructor(u, t) { this.usuario = u; this.token = t; }
        toString() { return JSON.stringify(this); }
        toKey() { return "key=" + this.token; }
        foto = Array();
        toKeyIdFoto(i) { return toKey() + this.foto[i]; }
        addFoto(foto) { this.foto.push(new Imagen(foto.idfoto, foto.ruta)); }
    }
    class Imagen {
        constructor(i, u) { this.idImg = i; this.uriImg = u; }
        verFoto() { console.log(this); console.log("id:" + this.idImg + "-" + this.uriImg); }
        toString() { return JSON.stringify(this); }
    }
    //obtiene los datos del login y llama ajax a servicio
    function obtenerImagenes() {
        console.log("obtenerImagenes() ... entra   ");
        xmlHttp = new XMLHttpRequest();
        mensajeFotos = new MensajeFotos();
        //obtener login para el mensaje con usuario+token
        var usuario = verLocal("login");
        login = JSON.parse(usuario);
        //crea un mesaje de "fotos"
        mensajeFotos = new MensajeFotos(login.nombre, login.tkn);
        xmlHttp.onreadystatechange = comprobarEstado;
        // URI con usuario + token
        uri = URI_SERVICE + "?" + mensajeFotos.toKey();
        xmlHttp.open('GET', uri, true);
        xmlHttp.send(null); //get: NO datos en body
        console.log("obtenerImagenes() ... sale   ");
    }
    /*function obtenerImagenes() {
        console.log("obtenerImagenes() ... entra   ");
        xmlHttp = new XMLHttpRequest();
        //componer mensaje para obtener la lista de fotos
        mensajeFotos = new MensajeFotos();
        //obtener login para el mensaje con usuario+token
        //login = new Usuario(usuario.nombre, usuario.token);
        //login = new Usuario(null, null, null);
        var usuario = verLocal("login");
        login = JSON.parse(usuario);
        //crea un mesaje de "fotos"
        mensajeFotos = new MensajeFotos(login.nombre, login.tkn);
        xmlHttp.onreadystatechange = comprobarEstado;
        // URI con usuario + token
        uri = URI_SERVICE + "?" + mensajeFotos.toKey();
        xmlHttp.open('GET', uri, true);
        xmlHttp.send(null); //get: NO datos en body
        console.log("obtenerImagenes() ... sale   ");
    }*/
    function comprobarEstado() {
        if (xmlHttp.readyState == 4) {
            if (xmlHttp.status == 200) {
                var cuerpo = JSON.parse(xmlHttp.responseText);
                console.log(" ** OK ** ... " + xmlHttp.status);
                console.log(" Retorno correcto. Cuerpo ... " + cuerpo);
                guardarImagenes(cuerpo);
            } else {
                console.log(" ** Error ** en el servicio ... " + xmlHttp.status);
                sacarError();
            }
        } //else { console.log(" En proceso - xmlHttp.status ... " + xmlHttp.readyState); }
    }
    function guardarImagenes(cuerpo) {
        //añadir las img's en el hook
        const HOOKIMG = document.getElementById("hookSelector");
        var listaImg = cuerpo; // .responseText;
        for (const img in listaImg) {
            if (listaImg.hasOwnProperty(img)) {
                var foto = listaImg[img];
                //crear imagen, botón e id con label
                var imgVista = document.createElement("img");
                var imgButton = document.createElement("button");
                var imgID = document.createElement("label");
                imgButton.appendChild(imgID).innerHTML = foto.idfoto;
                imgButton.id = foto.idfoto;
                imgButton.innerHTML = "Comentarios";
                // agregar cllbck event listener de comentarios
                //imgButton.click = "comentar(" + foto.idfoto + ")";
                imgButton.addEventListener("click", comentariosFoto);
                var div = document.createElement("div");
                imgVista.src = foto.ruta;
                //imgID.innerHTML = foto.nfoto;
                HOOKIMG.appendChild(div);
                div.appendChild(imgID);
                div.appendChild(imgVista);
                div.appendChild(imgButton);
                // id para agregar los comentarios al pulsar el botón
                div.id = "div" + foto.idfoto;
                mensajeFotos.addFoto(foto);  // push de la foto para guardar el id y la url, 
                //obtenerInfo(foto); // obtener del servidor los datos de la foto , nombre, comentario1
            }
            guardarLocal("imagenes", listaImg);
        }
        function obtenerInfo(img) {
            console.log("obtenerInfo() ... entra   ");
            xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = comprobarEstadoInfo;
            // URI con usuario + token
            uri = URI_SERVICE_INFO + "?" + mensajeFotos.toKeyIdFoto();
            xmlHttp.open('GET', uri, true);
            xmlHttp.send(null); //get: NO datos en body
            console.log("obtenerInfo() ... sale   ");
        }
        function comprobarEstadoInfo() {
            if (xmlHttp.readyState == 4) {
                if (xmlHttp.status == 200) {
                    var cuerpo = JSON.parse(xmlHttp.responseText);
                    console.log(" ** OK ** ... " + xmlHttp.status);
                    console.log(" Retorno correcto. Cuerpo ... " + cuerpo);
                    guardarImagen(cuerpo);
                } else {
                    console.log(" ** Error ** en el servicio ... " + xmlHttp.status);
                    sacarError();
                }
            }
        }
        // TO-DO : guardar localStorage con la lista de fotos
    }
    function infoImagen() {
        //SERVICIO 3 OBTENER INFORMACIÓN DE UNA FOTO
        //GET http://10.1.2.10:8081/cfticionic/foto?key=CQOYQYTQ3CP3&idfoto=3
    }
    function sacarError(cuerpo) {
        const RET = document.getElementById("_error");
        const RET_TXT = document.getElementById("_error_txt");
        RET.innerHTML = xmlHttp.status;
        RET_TXT.innerHTML = "Error en la llamada al servicio " + uri;
    }
    //function guardarLocal(clave, valor) { localStorage.setItem(clave, valor); console.log("Clave-saved " + clave + "[" + valor + "] = " + verLocal(clave)); }
    //function verLocal(clave) { valor = localStorage.getItem(clave); console.log("Clave-recuperado:" + clave + "-" + valor); return valor; }
    function comentariosFoto(idf) {
        console.log("idf:");
        console.log(idf);
        console.log("this:");
        console.log(this);
        //guardar la seleccion de la foto,
        // luego se necesita para recuperar/colocar los comentarios
        // en la vista
        var id = this.id;
        
        //Borrar los elementos hijos de los comentarios cargados
        var idvista = verLocal("idfoto");
        if (idvista) {
            var divid = document.getElementById("div" + idvista);
            while (divid.firstChild) {
                divid.removeChild(divid.firstChild);
            }
        }
        guardarLocal("idfoto", id);
        obtenerComentariosFoto(id);
    }
    function volver() { window.location.href = "./index.html"; }
    function obtenerComentariosFoto(id) {
        //GET http://10.1.2.10:8081/cfticionic/comentarios/foto?key=CQOYQYTQ3CP3&idfoto=5
        uri = "http://10.1.2.10:8081/cfticionic/comentarios/foto?key=" + login.tkn + "&idfoto=" + id;
        llamarSrv(uri, null, tratarComentarios);
    }
    function tratarComentarios(obj) {
        //FORMATO DEL MENSAJE DE VUELTA (JSON)
        /*[{"id":66,
        "autor":"alumno10",
        "idfoto":5,"momento":1574598838203,
        "texto":"la verdad, me ha gustado aunque el final un poco feo"},
        {"id":67,"autor":"alumno10",
        "idfoto":5,"momento":1574596744100,
        "texto":"a la dirección artística, pá matarla"}]*/
        var divid;
        //RECUPOERAR DIVID PARA LLENAR LA VISTA
        divid = document.getElementById("div" + verLocal("idfoto"));
        var ul = document.createElement("ul");
        divid.appendChild(ul);
        for (const clave in obj) {
            if (obj.hasOwnProperty(clave)) {
                const cmnt = obj[clave];
                //componer las etq de la vista
                var li = document.createElement("li");
                var span1 = document.createElement("span");
                span1.innerHTML = cmnt.id + "-" + cmnt.autor;
                var span2 = document.createElement("span");
                span2.innerHTML = cmnt.texto;
                li.appendChild(span1);
                li.appendChild(span2);
                ul.appendChild(li);
                //SI EL USUARIO ES EL MISMO 
                // ACTIVAR BOTON DE BORRADO Y MODIFICACION
                if (cmnt.autor == login.nombre){
                    var btnMod = document.createElement("button");
                    var btnBor = document.createElement("button");
                    btnMod.innerHTML = "modif cmntr";
                    btnMod.id=cmnt.id;
                    btnMod.addEventListener("click",modificarComentario);
                    btnBor.innerHTML = "borrar cmntr";
                    btnBor.id=cmnt.id;
                    btnBor.addEventListener("click",borrarComentario);
                    li.appendChild(btnMod);
                    li.appendChild(btnBor);
                }
            }
        }
    }
    function modificarComentario(){
        alert("modif comt:"+this.id)
    }
    function borrarComentario(){
        alert("BORRAR comt:"+this.id)
    }
</script>

<body>
    <h1>APP - Selección de imagen a comentar</h1>
    <!--     <h1>APP - Comentarios</h1> -->
    <h2>SELECCIÓN</h2>
    <div>
        <p> <button class="boton" type="button" onclick="volver()">Volver</button> </p>
        <p class="marco">
            <label>Seleccionar imagen a comentar</label>
            <div id="hookSelector">
                <!-- <span>Imagen:</span>
                <label id="_img_id"></label>
                <img id="_img_img" src="" /> -->
                <!-- <button onclick="cargaFoto(idFoto);">Comentar</button> -->
            </div>
        </p>
        <p> <button class="boton" type="button" onclick="volver()">Volver</button> </p>
    </div>
    <div id="retorno">
        <br />
        <label id="_error"></label> <br />
        <label id="_error_txt"></label> <br />
        <label id="_token"></label> <br />
        <label id="_clave"></label> <br />
        <label id="_valor"></label>
    </div>
</body>